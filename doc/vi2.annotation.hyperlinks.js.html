<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>vi2.annotation.hyperlinks.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Analysis.html">Analysis</a></li><li><a href="Annotation.html">Annotation</a><ul class='methods'><li data-type='method'><a href="Annotation.html#init">init</a></li></ul></li><li><a href="Comments.html">Comments</a></li><li><a href="DataBase.html">DataBase</a><ul class='methods'><li data-type='method'><a href="DataBase.html#getGroupById">getGroupById</a></li><li data-type='method'><a href="DataBase.html#getSlidesById">getSlidesById</a></li><li data-type='method'><a href="DataBase.html#getUserById">getUserById</a></li><li data-type='method'><a href="DataBase.html#loadJSON">loadJSON</a></li></ul></li><li><a href="Log.html">Log</a></li><li><a href="Loop.html">Loop</a></li><li><a href="Maintain.html">Maintain</a><ul class='methods'><li data-type='method'><a href="Maintain.html#validateTags">validateTags</a></li></ul></li><li><a href="Parser.html">Parser</a><ul class='methods'><li data-type='method'><a href="Parser.html#parseHtml">parseHtml</a></li><li data-type='method'><a href="Parser.html#parseWiki">parseWiki</a></li><li data-type='method'><a href="Parser.html#parseWikiHyperlink">parseWikiHyperlink</a></li><li data-type='method'><a href="Parser.html#parseWikiVideo">parseWikiVideo</a></li><li data-type='method'><a href="Parser.html#run">run</a></li></ul></li><li><a href="Utils.html">Utils</a></li><li><a href="Vi2.Assessment.html">Assessment</a></li><li><a href="vi2.core.Clock.html">Clock</a><ul class='methods'><li data-type='method'><a href="vi2.core.Clock.html#isHook">isHook</a></li></ul></li><li><a href="Vi2.Metadata.html">Metadata</a><ul class='methods'><li data-type='method'><a href="Vi2.Metadata.html#buildMetaTags">buildMetaTags</a></li><li data-type='method'><a href="Vi2.Metadata.html#displayMetadata">displayMetadata</a></li><li data-type='method'><a href="Vi2.Metadata.html#update">update</a></li></ul></li><li><a href="Vi2.PlaybackSpeed.html">PlaybackSpeed</a><ul class='methods'><li data-type='method'><a href="Vi2.PlaybackSpeed.html#decreaseSpeed">decreaseSpeed</a></li><li data-type='method'><a href="Vi2.PlaybackSpeed.html#displaySpeed">displaySpeed</a></li><li data-type='method'><a href="Vi2.PlaybackSpeed.html#getCurrentSpeed">getCurrentSpeed</a></li><li data-type='method'><a href="Vi2.PlaybackSpeed.html#increaseSpeed">increaseSpeed</a></li><li data-type='method'><a href="Vi2.PlaybackSpeed.html#init">init</a></li><li data-type='method'><a href="Vi2.PlaybackSpeed.html#setCurrentSpeed">setCurrentSpeed</a></li></ul></li><li><a href="Vi2.RelatedVideos.html">RelatedVideos</a><ul class='methods'><li data-type='method'><a href="Vi2.RelatedVideos.html#showRelatedVideos">showRelatedVideos</a></li><li data-type='method'><a href="Vi2.RelatedVideos.html#sortByRelevance">sortByRelevance</a></li></ul></li><li><a href="Vi2.Sharing.html">Sharing</a><ul class='methods'><li data-type='method'><a href="Vi2.Sharing.html#init">init</a></li><li data-type='method'><a href="Vi2.Sharing.html#prepareEmbedMarkup">prepareEmbedMarkup</a></li></ul></li><li><a href="Vi2.SkipBack.html">SkipBack</a><ul class='methods'><li data-type='method'><a href="Vi2.SkipBack.html#init">init</a></li></ul></li><li><a href="Vi2.SyncMedia.html">SyncMedia</a><ul class='methods'><li data-type='method'><a href="Vi2.SyncMedia.html#get_tag_by_name">get_tag_by_name</a></li><li data-type='method'><a href="Vi2.SyncMedia.html#init">init</a></li></ul></li><li><a href="Vi2.TableOfContents.html">TableOfContents</a><ul class='methods'><li data-type='method'><a href="Vi2.TableOfContents.html#addTimelineMarkers">addTimelineMarkers</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#appendToDOM">appendToDOM</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#begin">begin</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#createMenu">createMenu</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#createTimelineControl">createTimelineControl</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#end">end</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#init">init</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#init">init</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#nextElement">nextElement</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#previousElement">previousElement</a></li></ul></li><li><a href="Vi2.TemporalBookmarks.html">TemporalBookmarks</a><ul class='methods'><li data-type='method'><a href="Vi2.TemporalBookmarks.html#init">init</a></li></ul></li><li><a href="Vi2.VideoManager.html">VideoManager</a><ul class='methods'><li data-type='method'><a href="Vi2.VideoManager.html#handleAllStreams">handleAllStreams</a></li><li data-type='method'><a href="Vi2.VideoManager.html#handleCategory">handleCategory</a></li><li data-type='method'><a href="Vi2.VideoManager.html#handleNewStream">handleNewStream</a></li><li data-type='method'><a href="Vi2.VideoManager.html#handleTags">handleTags</a></li><li data-type='method'><a href="Vi2.VideoManager.html#init">init</a></li><li data-type='method'><a href="Vi2.VideoManager.html#loadWidgets">loadWidgets</a></li></ul></li><li><a href="Vi2.ViewingHistory.html">ViewingHistory</a><ul class='methods'><li data-type='method'><a href="Vi2.ViewingHistory.html#init">init</a></li></ul></li><li><a href="Vi2.Zoom.html">Zoom</a><ul class='methods'><li data-type='method'><a href="Vi2.Zoom.html#init">init</a></li></ul></li><li><a href="VideoPlayer.html">VideoPlayer</a><ul class='methods'><li data-type='method'><a href="VideoPlayer.html#createPlaybackControl">createPlaybackControl</a></li><li data-type='method'><a href="VideoPlayer.html#createSource">createSource</a></li><li data-type='method'><a href="VideoPlayer.html#createVolumeControl">createVolumeControl</a></li><li data-type='method'><a href="VideoPlayer.html#decreaseVolume">decreaseVolume</a></li><li data-type='method'><a href="VideoPlayer.html#getVolume">getVolume</a></li><li data-type='method'><a href="VideoPlayer.html#increaseVolume">increaseVolume</a></li><li data-type='method'><a href="VideoPlayer.html#loadUI">loadUI</a></li><li data-type='method'><a href="VideoPlayer.html#muteVolume">muteVolume</a></li><li data-type='method'><a href="VideoPlayer.html#readyStateHandler">readyStateHandler</a></li><li data-type='method'><a href="VideoPlayer.html#setVolume">setVolume</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-some.html">some</a></li></ul><h3>Global</h3><ul><li><a href="global.html#init">init</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">vi2.annotation.hyperlinks.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* 
*	name: Vi2.Hyperlinks
*	author: niels.seidel@nise81.com
* license: MIT License
*	description: 
* dependencies:
*  - jquery-1.11.2.min.js
*  - jquery.inherit-1.1.1.js
*  - ejs.js
*	todo:
	- include editor from vi-wiki 
	- nice defaults: var defaults = {animLen: 350}; 
	- apply minimum link duration
	- delay removeOverlay on mouseover/shift-press etc.
	
*/

/* 
 * class Hyperlinks 
 **/ 
Vi2.Hyperlinks = $.inherit( Vi2.Annotation,/** @lends Hyperlinks# */{

		/* @constructs
		 *		@extends Annotation
		 *		@param {object} options An object containing the parameters
     *		
     *		@param {string} options.displaySelector An optional setting.
		 **/
  	__constructor : function(options) { 	
  		this.options = $.extend(this.options, options); 
		},
				
		name : 'hyperlinks',
		type : 'annotation',
		
		options : {
			displaySelector: '#seq',
 			hasTimelineMarker: true,
 			timelineSelector : '.vi2-timeline-top', 
			hasMenu : true,
			menuSelector: '#hyperlinks',
			minDuration: 5, // seconds
			allowEditing : true,
			allowCreation : true, 
			path: '/static/img/user-icons/'
		},
		player : null,
		link_list : {},
		currLinkId :-1,

		/* 
		 *
		 **/
		init : function(ann){
			this.clear(); 
			var events = [];
			$.each(ann, function(i, val){ 
				if( val.linktype === 'cycle' || val.linktype === 'standard' || val.linktype === 'external'){ // former also  val.linktype == 'standard' ||
				events.push({ 
						name: val.title, 
						occ:[val.t1], 
						target: val.target,
						description: ( val.description ), 
						time :[val.t1],
						duration: val.t2, 
						x:val.x,
						y:val.y,
						date: val.date, 
						author: val.author 
				});
				}
			}); //{"occ":["1690"],"target":"#!moss","time":["1690"],"date":"1416312331209","author":"admin"}
			
			// show comments in a menu
			if( this.options.hasMenu ){ 
				this.createMenu(events);
			}
			
			// map events on the timeline
			if( this.options.hasTimelineMarker ){ 
				vi2.observer.player.timeline.addTimelineMarkers( 'hyperlinks', events, this.options.timelineSelector );
			}		
		},		
		
		
		/* 
			* Translated database entry of link into a dom element that the parser will read later on 
			**/
		appendToDOM : function(id){
			var _this = this;
			$(vi2.dom).find('[type="hyperlinks"]').each(function(i,val){ $(this).remove(); });
			$(vi2.dom).find('[type="cycle"]').each(function(i,val){ $(this).remove(); });
			 
			$.each(	vi2.db.getLinksById(id), function(i, val){  
				var links = $('&lt;div>&lt;/div>')
				.attr('type', val.type) // former default: "xlink"
				.attr('starttime', val.starttime)//vi2.utils.deci2seconds(this.start))
				.attr('duration', val.duration)
				.attr('posx', val.x)
				.attr('posy', val.y)
				.attr('seek', vi2.utils.deci2seconds(this.seek))
				.attr('duration2', vi2.utils.deci2seconds(this.duration2))
				.attr('target', val.target)
				.attr('description', decodeURIComponent( val.description) )
				.attr('author', val.author)
				.attr('date', val.date)
				.text( decodeURIComponent(val.title) )
				.appendTo( vi2.dom )
				;
			});
			
		},	
		
		
		/**
			*
			*/
		updateDOMElement : function( obj ){  
			$(vi2.dom)
				.find('[date="'+ obj.date +'"]')
				.attr('author', vi2.wp_user )
				.attr('date', new Date().getTime())
				.attr('starttime', obj.time )
				.attr('description', decodeURIComponent( obj.content.description ) )
				.attr('duration', obj.content.duration === undefined ? '10' : obj.content.duration )
				.attr('posx', obj.content.x === undefined ? '20' : obj.content.x  )
				.attr('posy', obj.content.y === undefined ? '80' : obj.content.y  )
				.attr('seek', 0 )// obj.conetnt.seek
				.attr('duration2', 0 )//obj.content.duration2
				.attr('target', obj.content.target)
				.text( decodeURIComponent(obj.content.label) ); 
		},
		
		
		/**
			* @todo { type: type, date: new Date().getTime(), time: formData.time, content: formData.content); 
			*/
		addDOMElement : function( obj ){ 
			$('&lt;div>&lt;/div>')
				.attr('type', obj.type)
				.attr('author', vi2.wp_user )
				.attr('date', new Date().getTime())
				.attr('starttime', obj.time )
				.attr('duration', obj.content.duration === undefined ? '10' : obj.content.duration )
				.attr('posx', obj.content.x === undefined ? '20' : obj.content.x  )
				.attr('posy', obj.content.y === undefined ? '80' : obj.content.y  )
				.attr('seek', 0 )// obj.conetnt.seek
				.attr('duration2', 0 )//obj.content.duration2
				.attr('target', obj.content.target)
				.attr('description', decodeURIComponent( obj.content.description ))
				.text( decodeURIComponent(obj.content.label) )
				.appendTo( vi2.dom ); 
		},
		
		
		/**
		* Builds a list menu of all entries of the table of content
		*/
		createMenu : function(hyperlinksData){  
			var _this = this;
			var hyperlinks = $('&lt;ul>&lt;/ul>')
				.addClass('hyperlinks-list');
			$( this.options.menuSelector ).html( hyperlinks );	 
			
			$.each(hyperlinksData, function(i, val){  
					var a = $('&lt;a>&lt;/a>')
					.text( decodeURIComponent( val.name ) )
					.addClass('id-'+ val.occ[0])
					.attr('href', '#!/video/' + vi2.observer.current_stream + '/t=npt:' + val.occ[0] + '') // former: main.options.id
					;				
					var user = vi2.db.getUserById( val.author );	
			
					var li = $('&lt;li>&lt;/li>')
						.addClass('hyperlinks-'+val.occ[0])
						.attr('id', ''+ val.occ[0])
						.attr('title', user.username+', ' + moment(Number(val.date), "x").fromNow())
						//.css('list-style-image',  "url('"+_this.options.path+"user-"+val.author+".png')")
						.html(a)
						.appendTo( hyperlinks )
						; 
					var data = {
								time: val.occ[0],
								date: val.date,
								author: val.author,
								content : {
									label: val.name, 
									date: val.date,
									duration: val.duration, 
									description: val.description,
									target: val.target,
									x: val.x,
									y: val.y,
									seek: 0,//val.seek,
									duration2: 0//val.duration2 
								}
							};
							
					// editing		
					if( _this.options.allowEditing ){		 // evtl. &amp;&amp; Number(val.author) === Number(vi2.wp_user) 
						var edit_btn = $('&lt;a>&lt;/a>')
							.addClass('tiny-edit-btn glyphicon glyphicon-pencil tiny-edit-btn-'+ _this.name)
							.attr('data-toggle', "modal")
							.attr('data-target', "#myModal")
							.attr('data-annotationtype', 'hyperlinks')
							.data('annotationdata', data )
							.appendTo( li )
							;
					}
					
					li.click(function(){
						vi2.observer.log({context:'hyperlinks',action:'menu-click',values:[val.name,val.author,val.occ[0]]} ); 
						vi2.observer.player.currentTime( val.occ[0] );
						_this.currentTocElement = i;
					});	
				
			});// end each
		
			// sort list entries by time and append them
			hyperlinks
				.find('li').tsort( { attr:"id" } );  // tsort is error prune under chromium
					
			
		},			
		
		
		/** 
			* Begin of XLink annotation. Typically the link anchor will apeare on screen. There are three different link types: standard (target within video collection), external (target elsewhere in the WWW) and cycle (like standard link but with the option to return to the link source).
			* @param {Object} e
			* @param {String} id
			* @param {Object} obj		
		*/
		begin : function(e, id, obj){  
				this.currLinkId = id;
				var _this = this;
				
				// distinguish link types as icons
				var ltype = $('&lt;span>&lt;/span>');
				var expression = /[-a-zA-Z0-9@:%_\+.~#?&amp;//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&amp;//=]*)?/gi;
				var regex = new RegExp(expression);
				if (obj.content.target.match(regex) ){
					obj.linktype = 'external';
					ltype.addClass('glyphicon glyphicon-share-alt');
				} else {
					obj.linktype = 'standard';
					ltype.addClass('glyphicon glyphicon-link');
				}
				
				var o = $('&lt;a>&lt;/a>')
					.text(' ' +( decodeURIComponent( obj.content.title ) ) )
					.attr('id', 'ov'+id)
					.attr('href', obj.content.target )
					.attr('title', ( obj.content.description ) )
					.addClass('overlay ov-'+id+' hyperlink-'+obj.linktype)
					.bind('click', function(data){ 
						// log click
						vi2.observer.log({context:'hyperlinks',action:'link-'+obj.linktype+'-click',values:[obj.content.target, obj.author, obj.displayPosition.t1]} );
	 					// distinguish link types
	 					switch(obj.linktype){
	 						case 'standard' : 	// called xlink
	 							return true;
	 							//var new_stream = obj.content.target.replace(/\#!/,'');
								//vi2.observer.setCurrentStream(new_stream);
								
							case 'external' :
								return true;
							case 'cycle' : 
								var new_stream = obj.content.target.replace(/\#!/,'');
								vi2.observer.setCurrentStream(new_stream);
								// make new object for return link
								var return_obj = {
									title : 'return to: '+obj.content.title,
									target : String(_this.player.url).replace(/.webm/,'').replace(/videos\/iwrm\_/,''), // dirty IWAS hack
									linktype : 'standard',
									type : 'xlink',
									x : 2, //obj.displayPosition.x,
									y : 93, // obj.displayPosition.y,
									t1 : obj.seek,
									t2 : obj.duration,
									seek : obj.displayPosition.t1,
									duration : 0
								};	
								// append that object
								vi2.observer.vid_arr[0].annotation.push(return_obj); 
								//	_this.loadCycleVideo(obj.content.target, 10, 15, obj.displayPosition.t1); // url, seek time, duration, return_seek
								break;
							case 'x':
								break;	
						}
						// load Video
						_this.loadVideo(vi2.observer.vid_arr[0].url , obj.seek);
						
						// remove link ancshor after click 
						$(this).remove();
					})
					.prepend( ltype )
					.appendTo( this.options.displaySelector )
					.css({left: obj.displayPosition.x+'%', top: obj.displayPosition.y+'%', position:'absolute'})
					.effect( "highlight", 500 ) // could be improved
					; 
		},
	
	
		/** 
				*
				* End of annotion time. The link anchor will disapear from screen. 
				*/
		end : function(e, id){ 	 
			$( this.options.displaySelector + ' .ov-'+id ).hide();
		},
		
		
		/** 
				*
				*/
		clear : function(){ 
			$( this.options.displaySelector ).html('');
			// xxx static, stands in relative with template of videoplayer
			$('.vi2-video-seeklink').html('');
			
		},
		
		
		/*
		* 
		**/
		createAnnotationForm : function( data ){ 
			/*jshint multistr: true */
			var str = "\
			&lt;div class='input-group'>\
				&lt;span class='input-group-addon' id='hyperlinks-form1'>ULR&lt;/span>\
				&lt;input type='text' class='form-control' value='&lt;%= content.target %>' name='hyperlinks-entry-url' data-datatype='string' placeholder='' aria-describedby='hyperlinks-form1'>\
			&lt;/div>&lt;br>\
			&lt;div class='input-group'>\
				&lt;span class='input-group-addon' id='hyperlinks-form1'>Bezeichner&lt;/span>\
				&lt;input type='text' class='form-control' value='&lt;%= content.label %>' name='hyperlinks-entry-label' data-datatype='string' placeholder='' aria-describedby='hyperlinks-form12'>\
			&lt;/div>&lt;br>\
			&lt;div class='input-group'>\
				&lt;span class='input-group-addon' id='hyperlinks-form2'>Beschreibung&lt;/span>\
				&lt;textarea name='hyperlinks-entry-desc' data-datatype='string' placeholder='' aria-describedby='hyperlinks-form2'>&lt;%= content.description %>&lt;/textarea>\
			&lt;/div>&lt;br>\
			&lt;div class='input-group'>\
				&lt;span class='input-group-addon' id='hyperlinks-form3'>Zeitpunkt (s)&lt;/span>\
				&lt;input type='text' class='form-control' value='&lt;%= time %>' name='hyperlinks-entry-time' data-datatype='decimal-time' placeholder='' aria-describedby='hyperlinks-form3'>\
			&lt;/div>\
			&lt;div class='input-group'>\
				&lt;span class='input-group-addon' id='hyperlinks-form66'>Anzeigedauer (s)&lt;/span>\
				&lt;input type='text' class='form-control' value='&lt;%= content.duration %>' name='hyperlinks-entry-duration' data-datatype='decimal-time' placeholder='' aria-describedby='hyperlinks-form3'>\
			&lt;/div>\
			&lt;div class='input-group'>\
				&lt;span class='input-group-addon' id='hyperlinks-form66'>Position x (%)&lt;/span>\
				&lt;input type='text' class='form-control' value='&lt;%= content.x %>' name='hyperlinks-entry-x' data-datatype='number' placeholder='' aria-describedby='hyperlinks-form3'>\
			&lt;/div>\
			&lt;div class='input-group'>\
				&lt;span class='input-group-addon' id='hyperlinks-form66'>Position y (%)&lt;/span>\
				&lt;input type='text' class='form-control' value='&lt;%= content.y %>' name='hyperlinks-entry-y' data-datatype='number' placeholder='' aria-describedby='hyperlinks-form3'>\
			&lt;/div>\
			"; 
			if( data.content !== '' ){
				data.content.description = decodeURIComponent( data.content.description );
				data.content.label = decodeURIComponent( data.content.label );
				return ejs.render(str, data);
			}	else{
				return ejs.render(str, { 
					content: { 
						description:'', 
						target:'', 
						label:'',
						duration:10,
						x: 50,
						y: 50
					}, 
					time: vi2.observer.player.currentTime(), 
					date: (new Date().getTime()),
					author: vi2.wp_user 
				});	
			}	
		},
		
		
		/*
		*
		**/
		getAnnotationFormData : function( selector ){ //encodeURIComponent
			return {
				time: $( selector ).find('[name="hyperlinks-entry-time"]').attr('value'),
				content: {
					label: ($( selector ).find('[name="hyperlinks-entry-label"]').val() ), 					
					target: $( selector ).find('[name="hyperlinks-entry-url"]').val(),
					description: ( $( selector ).find('[name="hyperlinks-entry-desc"]').val() ),// opt	
					duration:  $( selector ).find('[name="hyperlinks-entry-duration"]').val(),
					x:  $( selector ).find('[name="hyperlinks-entry-x"]').val(),
					y:  $( selector ).find('[name="hyperlinks-entry-y"]').val(),
					seek:  0,//$( selector ).find('[name="hyperlinks-entry-seek"]').val(),// opt
					duration2:  0 //$( selector ).find('[name="hyperlinks-entry-duration2"]').val()// opt						
				}	
			};
		},
		
		
		/** Loads video from url and seeks to a dedicated position in time. 
		*		@param {String} url 
		* 	@param {Number} seek 
		*/
  	loadVideo : function(url, seek){
	  	this.player.loadVideo(url, seek);  			
  	},
  	
  	
  	/** 
				*
				*/
  	loadCycleVideo : function(url, seek, duration, return_seek){
	  	this.player.loadCycleVideo(url, seek, duration, return_seek);  			
  	}
  	
	}); // end class XLink


</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Nov 27 2016 13:13:03 GMT+0100 (Западная Европа (зима)) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
