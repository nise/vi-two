<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>vi2.core.annotated-timeline.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Analysis.html">Analysis</a></li><li><a href="Annotation.html">Annotation</a><ul class='methods'><li data-type='method'><a href="Annotation.html#init">init</a></li></ul></li><li><a href="Comments.html">Comments</a></li><li><a href="DataBase.html">DataBase</a><ul class='methods'><li data-type='method'><a href="DataBase.html#getGroupById">getGroupById</a></li><li data-type='method'><a href="DataBase.html#getSlidesById">getSlidesById</a></li><li data-type='method'><a href="DataBase.html#getUserById">getUserById</a></li><li data-type='method'><a href="DataBase.html#loadJSON">loadJSON</a></li></ul></li><li><a href="Log.html">Log</a></li><li><a href="Loop.html">Loop</a></li><li><a href="Maintain.html">Maintain</a><ul class='methods'><li data-type='method'><a href="Maintain.html#validateTags">validateTags</a></li></ul></li><li><a href="Parser.html">Parser</a><ul class='methods'><li data-type='method'><a href="Parser.html#parseHtml">parseHtml</a></li><li data-type='method'><a href="Parser.html#parseWiki">parseWiki</a></li><li data-type='method'><a href="Parser.html#parseWikiHyperlink">parseWikiHyperlink</a></li><li data-type='method'><a href="Parser.html#parseWikiVideo">parseWikiVideo</a></li><li data-type='method'><a href="Parser.html#run">run</a></li></ul></li><li><a href="Utils.html">Utils</a></li><li><a href="Vi2.Assessment.html">Assessment</a></li><li><a href="vi2.core.Clock.html">Clock</a><ul class='methods'><li data-type='method'><a href="vi2.core.Clock.html#isHook">isHook</a></li></ul></li><li><a href="Vi2.Metadata.html">Metadata</a><ul class='methods'><li data-type='method'><a href="Vi2.Metadata.html#buildMetaTags">buildMetaTags</a></li><li data-type='method'><a href="Vi2.Metadata.html#displayMetadata">displayMetadata</a></li><li data-type='method'><a href="Vi2.Metadata.html#update">update</a></li></ul></li><li><a href="Vi2.PlaybackSpeed.html">PlaybackSpeed</a><ul class='methods'><li data-type='method'><a href="Vi2.PlaybackSpeed.html#decreaseSpeed">decreaseSpeed</a></li><li data-type='method'><a href="Vi2.PlaybackSpeed.html#displaySpeed">displaySpeed</a></li><li data-type='method'><a href="Vi2.PlaybackSpeed.html#getCurrentSpeed">getCurrentSpeed</a></li><li data-type='method'><a href="Vi2.PlaybackSpeed.html#increaseSpeed">increaseSpeed</a></li><li data-type='method'><a href="Vi2.PlaybackSpeed.html#init">init</a></li><li data-type='method'><a href="Vi2.PlaybackSpeed.html#setCurrentSpeed">setCurrentSpeed</a></li></ul></li><li><a href="Vi2.RelatedVideos.html">RelatedVideos</a><ul class='methods'><li data-type='method'><a href="Vi2.RelatedVideos.html#showRelatedVideos">showRelatedVideos</a></li><li data-type='method'><a href="Vi2.RelatedVideos.html#sortByRelevance">sortByRelevance</a></li></ul></li><li><a href="Vi2.Sharing.html">Sharing</a><ul class='methods'><li data-type='method'><a href="Vi2.Sharing.html#init">init</a></li><li data-type='method'><a href="Vi2.Sharing.html#prepareEmbedMarkup">prepareEmbedMarkup</a></li></ul></li><li><a href="Vi2.SkipBack.html">SkipBack</a><ul class='methods'><li data-type='method'><a href="Vi2.SkipBack.html#init">init</a></li></ul></li><li><a href="Vi2.SyncMedia.html">SyncMedia</a><ul class='methods'><li data-type='method'><a href="Vi2.SyncMedia.html#get_tag_by_name">get_tag_by_name</a></li><li data-type='method'><a href="Vi2.SyncMedia.html#init">init</a></li></ul></li><li><a href="Vi2.TableOfContents.html">TableOfContents</a><ul class='methods'><li data-type='method'><a href="Vi2.TableOfContents.html#addTimelineMarkers">addTimelineMarkers</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#appendToDOM">appendToDOM</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#begin">begin</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#createMenu">createMenu</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#createTimelineControl">createTimelineControl</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#end">end</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#init">init</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#init">init</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#nextElement">nextElement</a></li><li data-type='method'><a href="Vi2.TableOfContents.html#previousElement">previousElement</a></li></ul></li><li><a href="Vi2.TemporalBookmarks.html">TemporalBookmarks</a><ul class='methods'><li data-type='method'><a href="Vi2.TemporalBookmarks.html#init">init</a></li></ul></li><li><a href="Vi2.VideoManager.html">VideoManager</a><ul class='methods'><li data-type='method'><a href="Vi2.VideoManager.html#handleAllStreams">handleAllStreams</a></li><li data-type='method'><a href="Vi2.VideoManager.html#handleCategory">handleCategory</a></li><li data-type='method'><a href="Vi2.VideoManager.html#handleNewStream">handleNewStream</a></li><li data-type='method'><a href="Vi2.VideoManager.html#handleTags">handleTags</a></li><li data-type='method'><a href="Vi2.VideoManager.html#init">init</a></li><li data-type='method'><a href="Vi2.VideoManager.html#loadWidgets">loadWidgets</a></li></ul></li><li><a href="Vi2.ViewingHistory.html">ViewingHistory</a><ul class='methods'><li data-type='method'><a href="Vi2.ViewingHistory.html#init">init</a></li></ul></li><li><a href="Vi2.Zoom.html">Zoom</a><ul class='methods'><li data-type='method'><a href="Vi2.Zoom.html#init">init</a></li></ul></li><li><a href="VideoPlayer.html">VideoPlayer</a><ul class='methods'><li data-type='method'><a href="VideoPlayer.html#createPlaybackControl">createPlaybackControl</a></li><li data-type='method'><a href="VideoPlayer.html#createSource">createSource</a></li><li data-type='method'><a href="VideoPlayer.html#createVolumeControl">createVolumeControl</a></li><li data-type='method'><a href="VideoPlayer.html#decreaseVolume">decreaseVolume</a></li><li data-type='method'><a href="VideoPlayer.html#getVolume">getVolume</a></li><li data-type='method'><a href="VideoPlayer.html#increaseVolume">increaseVolume</a></li><li data-type='method'><a href="VideoPlayer.html#loadUI">loadUI</a></li><li data-type='method'><a href="VideoPlayer.html#muteVolume">muteVolume</a></li><li data-type='method'><a href="VideoPlayer.html#readyStateHandler">readyStateHandler</a></li><li data-type='method'><a href="VideoPlayer.html#setVolume">setVolume</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-some.html">some</a></li></ul><h3>Global</h3><ul><li><a href="global.html#init">init</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">vi2.core.annotated-timeline.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* 
 * name: Vi2.AnnotatedTimline
 * author: niels.seidel@nise81.com
 * license: MIT License
 * description:
 * depends on:
 *  - jquery-1.11.2.min.js
 *  - jquery.inherit-1.1.1.js
 * related code:
 - timeline preview: https://github.com/brightcove/videojs-thumbnails/blob/master/videojs.thumbnails.js

 * todo:
 *   - cluster / zoom : - Vergleiche Darstellung von sehr vielen Markern bei Google Maps ...
 - diagramm (?)
 - filter
 - multi tracks
 - add slide preview
 - bug: previw is not exact and is loading very slow

 */


Vi2.AnnotatedTimeline = $.inherit(/** @lends Vi2.TableOfContents# */{ // 

  /** @constructs
   *		@param {object} options An object containing the parameters
   */
  __constructor : function(video, options, seek) {
    this.video = video;
    this.options = $.extend(this.options, options);
    this.seek = seek === undefined ? 0 : seek;
    this.init();
  },

  name : 'annotated timeline',
  type : 'core',
  options : {
    timelineSelector : '.vi2-timeline-main',
    hasPreview : false,
    hasSlidePreview: false,
    previewPath : '/static/img/video-stills/theresienstadt/still-image-',
    hasMarker : true,
    path:'/'
  },
  video : null,
  seek : 0,
  seeksliding: false,
  video_seek: null,

  video_loading_progress: null,
  video_timer: null,
  interval: 0,
  percentLoaded:0,
  video_container: null,
  cursorX : 0,

  /**
   Initializes the table of content and handles options
   */
  init : function(annotations){
    var _this = this;
    // init
    this.video = vi2.observer.player.video;
    this.video_seek = $( this.options.timelineSelector );
    this.video_loading_progress = $('.vi2-timeline-progress');
    this.video_timer = $('.vi2-video-timer'); // could become an option

    if( this.options.hasPreview ){
      this.createTimelineVideoPreview();
    }

    if( this.options.hasSlidePreview ){
      this.createTimelineSlidePreview();
    }

    // initiate event listeners, vi2.observer.log('loadingtime--video:'+url);
    var
      t0 = 0,
      t1 = 0
      ;
    this.video.onloadstart = function(e){
      // 1. event called
      t0 = Date.now();
    };
    this.video.ondurationchange = function(){
      // 2. event called
      t1 = ( Date.now() - t0 );
      //console.log('duration '+ ( Date.now() - t0 ) );
      _this.handleDurationChange();
    };
    this.video.onloadedmetadata = function(e){
      // 3. event called
      //console.log('load meta '+ ( Date.now() - t0 ) );
    };
    this.video.onloadeddata = function(e){
      // 4. event called
      vi2.observer.log({context:'player', action:'video-loading-time', values:[t1, ( Date.now() - t0 )]});
      //console.log('load data '+ ( Date.now() - t0 ) );
    };
    this.video.onprogress = function(e){
      // 5. event called
    };
    this.video.oncanplay = function(e){
      // 6. event called
      //console.log('can play '+ ( Date.now() - t0 ) );
    };
    this.video.oncanplaythrough = function(e){
      // 7. event called
      //console.log('can play through '+ ( Date.now() - t0 ) );
    };


    this.video.addEventListener('timeupdate', function(e){
      _this.handleTimeupdate(e);
    });

  },

  /**
   * Creates a timeline slider to seek within the playback time
   */
  createTimelineControl : function() {
    var _this = this;
    //
    /*if (this.video.readyState) {
     clearInterval(this.interval);
     clearInterval(this.interval);*/
    //var video_duration = _this.video.duration; //$(this.options.selector).attr('duration');
    this.video_seek.slider({
      value: 0,
      step: 0.01,
      orientation: 'horizontal',
      range: 'min',
      max: vi2.observer.player.duration(),
      animate: false,
      slide: function(event, ui) {
        _this.seeksliding = true;
      },
      start: function(event, ui) {
        vi2.observer.log({context:'player',action:'seek-start',values: [ui.value]} );
        _this.buffclick++;
        _this.seeksliding = true;
      },
      stop: function(event, ui) {
        vi2.observer.log({context:'player',action:'seek-stop',values:[ui.value]}	);
        _this.seeksliding = false;
        //if(_this.percentLoaded > (ui.value / _this.duration())){
        vi2.observer.player.currentTime( parseFloat(Math.ceil(ui.value)) ); // XXX bugy / webkit fix
      }

    });

    /*} else {
     // try reinitiate the slider as long the ...?
     this.interval = setInterval(function() { _this.createTimelineControl(); }, 150);
     }*/

  },

  /*
   * Add Video preview on timeline
   * todo: event could be logged
   **/
  createTimelineVideoPreview : function(){
    var
      _this = this,
      width = $( this.options.timelineSelector ).width(),
      left = ($( this.options.timelineSelector )).offset().left,
      t = 1,
      o = null
      ;

    var img = new Image();
    img.id = 'videopreview';//);//.attr('src', _this.options.previewPath + "001.jpg");
    var timeline_preview = $('&lt;div>&lt;/div>')
      .addClass('vi2-timeline-preview')
      .html( img )
      .appendTo( _this.options.timelineSelector );

    // event
    var handleTimelineMoves = function(event){
      $( timeline_preview ).css({ left: (event.pageX - 100) });
      t = (Math.round( ( event.pageX / width ) * vi2.observer.player.duration() ) - 20); // correction value is unclear
      o = new Image();
      img_selector = document.getElementById("videopreview");
      listener = function(event2){
        img_selector.src = o.src;
      };
      o.removeEventListener('load', listener, false);
      o.addEventListener('load', listener, false);
      o.src = _this.options.previewPath + "" + t + ".jpg";//  + "?_=" + (+new Date());
      o.onerror = function () { this.style.display = "none"; };
    };
    var el = document.getElementsByClassName( 'vi2-timeline-main' );
    el[0].removeEventListener('mousemove', handleTimelineMoves );
    el[0].addEventListener('mousemove', handleTimelineMoves );
  },

  /*
   * Add Video preview on timeline
   * todo: event could be logged
   **/
  createTimelineSlidePreview : function(){
    var
      _this = this,
      width = $( this.options.timelineSelector ).width(),
      left = $( this.options.timelineSelector ).offset().left,
      t = 1,
      o = null
      ;
    var timeline_preview = $('&lt;div>&lt;/div>')
      .addClass('vi2-timeline-preview')
      .appendTo( this.options.timelineSelector );

    // event
    var el = document.getElementsByClassName( 'vi2-timeline-main' );
    el[0].addEventListener('mousemove', function(event){
      $( timeline_preview ).css({ left: (event.pageX - 100) });
      t = (Math.floor( ( vi2.observer.player.duration() / width ) * Math.floor(event.pageX) )).toString();

      o = new Image();
      o.src = _this.options.previewPath + "" + t + ".png";
      listener = function(event2){
        $( timeline_preview )
        //.css({ left: (event.pageX - 100) })
          .html(o);
      };
      o.removeEventListener('load', listener, true);
      o.addEventListener('load', listener, true);
    }, false);
  },

  /**
   * Displays markers on the timeline
   * options: hasTooltip, clickable, type,
   */
  addTimelineMarkers : function(type, data, timelineSelector){
    var _this= this;
    if( timelineSelector === undefined ){
      timelineSelector = this.options.timelineSelector;
    } 
    this.options[ type ] = { markerHasTooltip: true, markerIsClickable:true };
    var timeline = $( timelineSelector );

    // remove existing markes of the same type before rewriting them
    $('.'+type + '-timeline-marker').each(function(i, val){ $(val).remove(); });

    $.each( data, function(i, val){ 
      var progress = val.occ[0] / vi2.observer.player.duration();
      progress = ((progress) * $( timelineSelector ).width());
      if (isNaN(progress) || progress > $( timelineSelector ).width()) { return;}

      var sp = $('&lt;a>&lt;/a>')			// $('&lt;span>&lt;/span>');
          .addClass( type + '-timeline-marker ttoc')
          .attr('style','left:'+ progress +'px;')
        ;
      if( _this.options[ type ].markerHasTooltip){
        sp
          .attr('title', val.name)
          .attr('data-toggle', 'tooltip');
      }
      if( _this.options[ type ].markerIsClickable ){
        sp.bind('click', function(event){
          vi2.observer.player.currentTime( val.occ[0] );
          // xxx bug for type === assessment !!! todo
          vi2.observer.log( {context:type, action:'timeline-link-click',values:[val.name,val.author,val.occ[0]]});
        });
      }
      timeline.append(sp); // val.title
    });
  },

  /*
   * Event is called when the total playback time has been determined
   **/
  handleDurationChange : function(e) {
    this.createTimelineControl();
    //if( $(_this.options.selector).attr('duration') != undefined )

    vi2.observer.player.currentTime( this.seek );
    $(vi2.observer).trigger('player.ready', [vi2.observer.player.seqList[vi2.observer.player.seqNum].id, vi2.observer.player.seqNum]);


    /*if (Number(this.seek) > 0) {
     if(this.percentLoaded > (this.seek / this.duration())){
     //this.currentTime(seek); // bugy in production use or on remote sites
     vi2.observer.player.currentTime( this.seek );
     $(vi2.observer).trigger('player.ready', [vi2.observer.player.seqList[vi2.observer.player.seqNum]['id'], vi2.observer.player.seqNum]);
     }
     }*/

  },

  /*
   * Event is called during the videos is buffering
   **/
  handleProgress : function (e) {
    //_this.setProgressRail(e);
    var
      target = this.video;//(e != undefined) ? e.target : this.video,
    percent = null;

    if (target &amp;&amp; target.buffered &amp;&amp; target.buffered.length > 0 &amp;&amp; target.buffered.end &amp;&amp; target.duration) {
      percent = target.buffered.end(0) / target.duration;
    } else if (target &amp;&amp; target.bytesTotal !== undefined &amp;&amp; target.bytesTotal > 0 &amp;&amp; target.bufferedBytes !== undefined) {
      percent = target.bufferedBytes / target.bytesTotal;
    } else if (e &amp;&amp; e.lengthComputable &amp;&amp; e.total !== 0) {
      percent = e.loaded/e.total;
    }

    if (percent !== null) {
      this.percentLoaded = percent;
      percent = Math.min(1, Math.max(0, percent));

      if (this.video_loading_progress &amp;&amp; this.video_seek) {
        this.video_loading_progress.width(this.video_seek.width() * percent);
      }
    }

  },


  /*
   * Event is called every time when the playback time changes
   **/
  handleTimeupdate : function(e) {
    if (!this.seeksliding) {
      this.video_seek.slider('value', vi2.observer.player.currentTime() ); // / vi2.observer.player.duration()
    }
    //this.video_timer.text( vi2.utils.seconds2decimal( vi2.observer.player.currentTime() ) + ' / ' + vi2.utils.seconds2decimal( vi2.observer.player.duration() ));
  },


  /*
   * 
   **/
  highlightTimeline : function(videoElement, timelineSelector, firstLoopPoint, secondLoopPoint, countLoopTimelinePoints) {
    
    var videoDuration = videoElement.duration;
    var loopMarker = document.createElement('span');
    loopMarker.classList.add('vi2-timeline-loop-marker');

    if (countLoopTimelinePoints === 0) {
      $( timelineSelector ).append(loopMarker);
      loopMarker.style.left = (firstLoopPoint/videoDuration * 100) + '%';

    } else if (countLoopTimelinePoints === 1) {
      var firstCreatedLoopMarker = $( timelineSelector ).find('.vi2-timeline-loop-marker');
      firstCreatedLoopMarker.parent().remove( firstCreatedLoopMarker );
      $( timelineSelector ).append(loopMarker);
      loopMarker.style.left = (firstLoopPoint/videoDuration * 100) + '%';
      loopMarker.style.width = (secondLoopPoint/videoDuration * 100) - (firstLoopPoint/videoDuration * 100) + '%';

    }
  },


  /*
   **/
  deleteHighlightTimeline :  function( timelineSelector ) {
    
    var loopMarkersArray = $( timelineSelector ).find('.vi2-timeline-loop-marker');

    for (var i = 0; i &lt; loopMarkersArray.length; i++) {
      loopMarkersArray[i].parentNode.removeChild(loopMarkersArray[i]);
    }
  },

  /**/
  pixelInTime : function(){}




  /* --
   setCurrentRail: function(e) {

   var t = this;

   if (t.media.currentTime != undefined &amp;&amp; t.media.duration) {

   // update bar and handle
   if (t.total &amp;&amp; t.handle) {
   var
   newWidth = t.total.width() * t.media.currentTime / t.media.duration,
   handlePos = newWidth - (t.handle.outerWidth(true) / 2);

   t.current.width(newWidth);
   t.handle.css('left', handlePos);
   }
   }

   }	*/

}); // end class
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Nov 27 2016 13:13:03 GMT+0100 (Западная Европа (зима)) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
